<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../events-target-behavior/events-target-behavior.html">
<link rel="import" href="variables-context-builder-behavior.html">

<!--
`<variables-evaluator>` Variables evaluator for the Advanced REST Client

The element listens for `before-request` custom event and evaluates its
properties. This element is responsible for applying variables to the request.

This elements works with `variables-manager`. When evaluation has been requested
it asks the manager for list of current variables. After the list is evaluated
then the requested value is evaluated for the variables.

### Example
```
<variables-evaluator></variables-evaluator>
```

A value can be evaluated on demand by dispatching `evaluate-variable` custom
event. It will perform evaluation on the `value` property of the detail object.
The element adds a `result` property to the detail object which is a Promise
that resolves to a value.
The event is cancelled and it's propagation is stopped so other evaluators won't
perform the same task again.

### Example

```javascript
// requesting to create an environment
var event = new CustomEvent('evaluate-variable', {
  bubbles: true,
  composed: true,
  cancelable: true,
  detail: {
    value: 'The timestamp is now() and generating random() value'
  }
});
document.dispatchEvent(event);
console.log(event.defaultPrevented); // true
event.detail.result.then(function(value) {
  console.log(value);
})
.catch(function(cause) {
  console.log(cause.message);
});
```

@group Logic Elements
@element variables-evaluator
@demo demo/index.html
-->
<script>
Polymer({
  is: 'variables-evaluator',

  behaviors: [
    ArcBehaviors.VariablesContextBuilderBehavior,
    ArcBehaviors.EventsTargetBehavior
  ],

  properties: {
    // A cache object for groupping
    cache: Object,
    // If set it will not handle `before-request` event
    noBeforeRequest: Boolean
  },

  _attachListeners: function(node) {
    this.listen(node, 'before-request', '_beforeRequestHandler');
    this.listen(node, 'evaluate-variable', '_evaluateVariableHandler');
  },

  _detachListeners: function(node) {
    this.unlisten(node, 'before-request', '_beforeRequestHandler');
    this.unlisten(node, 'evaluate-variable', '_evaluateVariableHandler');
  },

  _beforeRequestHandler: function(e) {
    if (this.noBeforeRequest) {
      return;
    }
    var promise = new Promise(function(request, resolve, reject) {
      this.cache = undefined;
      this.context = undefined;
      this._processBeforeRequest(request, resolve, reject);
    }.bind(this, e.detail));
    e.detail.promises.push(promise);
  },

  _processBeforeRequest: function(request, resolve, reject) {
    var promise;
    if (this.context) {
      promise = Promise.resolve(this.context);
    } else {
      promise = this.buildContext();
    }
    return promise
    .then(function(context) {
      var p = ['url', 'method', 'headers', 'payload']
      .map(function(property) {
        if (!request[property]) {
          return Promise.resolve();
        }
        return this.evaluateVariable(request[property], context)
        .then(function(value) {
          request[property] = value;
        });
      }, this);
      return Promise.all(p);
    }.bind(this))
    .then(function() {
      resolve(request);
    })
    .catch(function(cause) {
      reject(cause);
    });
  },

  _evaluateVariableHandler: function(e) {
    if (e.defaultPrevented) {
      return;
    }
    e.preventDefault();
    e.stopPropagation();

    e.detail.result = new Promise(function(value, resolve, reject) {
      this.cache = undefined;
      this.context = undefined;
      this._processVariableEvaluation(value, resolve, reject);
    }.bind(this, e.detail.value));
  },

  _processVariableEvaluation: function(value, resolve, reject) {
    return this.evaluateVariable(value)
    .then(function(result) {
      resolve(result);
    })
    .catch(function(cause) {
      reject(cause);
    });
  },
  /**
   * Finds cached group.
   *
   * @param {String} key A key where a function keeps cached objects
   * @param {String} group Group name. Defined by user as an argument.
   * @return {String} Cached value.
   */
  _findInCache: function(key, group) {
    if (!this.cache) {
      return;
    }
    if (!this.cache[key]) {
      return;
    }
    return this.cache[key][group];
  },
  /**
   * Stores value in cache.
   *
   * @param {String} key A key where a function keeps cached objects
   * @param {String} group Group name. Defined by user as an argument.
   * @param {String} value Cached value.
   */
  _storeCache: function(key, group, value) {
    if (!this.cache) {
      this.cache = {};
    }
    if (!this.cache[key]) {
      this.cache[key] = {};
    }
    this.cache[key][group] = value;
  }
});
</script>
